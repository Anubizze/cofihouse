<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="img/iconcofe.png">
    <title>Оформление заказа | Cofehouse</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/mainpay3.css">
    <script src="https://static.yookassa.ru/v1/checkout.js"></script>
</head>
<body>
    <nav class="navbar">
        <ul>
            <li><a href="index.html#home"><i class="fas fa-home"></i> Главная</a></li>
            <li><a href="index.html#about"><i class="fas fa-coffee"></i> О кофе</a></li>
            <li><a href="index.html#menu"><i class="fas fa-list-alt"></i> Меню</a></li>
            <li><a href="zernashop.html"><i class="fas fa-shopping-bag"></i> Магазин зерен</a></li>
            <li><a href="index.html#vacancies"><i class="fas fa-briefcase"></i> Вакансии</a></li>
            <li><a href="index.html#contacts"><i class="fas fa-phone-alt"></i> Контакты</a></li>
            <li><a href="#" id="cart-icon"><i class="fas fa-shopping-cart"></i> Корзина <span id="cart-count">0</span></a></li>
        </ul>
    </nav>

    <div class="container">
        <!-- Прогресс-бар -->
        <div class="progress-bar">
            <div class="progress" id="checkout-progress"></div>
        </div>
        
        <!-- Вкладки оформления заказа -->
        <div class="checkout-tabs">
            <div class="tab active" data-tab="cart">Корзина</div>
            <div class="tab" data-tab="delivery">Доставка</div>
            <div class="tab" data-tab="payment">Оплата</div>
        </div>
        
        <!-- Содержимое вкладки "Корзина" -->
        <div class="tab-content active" id="cart-tab">
            <h2 class="order-title"><i class="fas fa-shopping-cart"></i> Ваш заказ</h2>
            
            <div class="order-section">
                <div id="order-items">
                    <!-- Товары будут добавляться динамически -->
                </div>
            </div>
            
            <div class="order-summary">
                <div class="order-summary-row">
                    <span>Товары:</span>
                    <span id="order-subtotal">0 ₸</span>
                </div>
                <div class="order-summary-row">
                    <span>Доставка:</span>
                    <span id="delivery-cost">0 ₸</span>
                </div>
                <div class="order-total">
                    <span>Итого:</span>
                    <span id="order-total">0 ₸</span>
                </div>
            </div>
            
            <div class="tab-buttons">
                <button class="btn btn-secondary" onclick="window.location.href='zernashop.html'">
                    <i class="fas fa-arrow-left"></i> Вернуться в магазин
                </button>
                <button class="btn btn-primary" onclick="nextTab('delivery')">
                    Продолжить <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Содержимое вкладки "Доставка" -->
        <div class="tab-content" id="delivery-tab">
            <h2 class="order-title"><i class="fas fa-truck"></i> Данные доставки</h2>
            
            <div class="order-section">
                <div class="form-group">
                    <label for="name" class="form-label">Ваше имя</label>
                    <input type="text" id="name" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label for="phone" class="form-label">Телефон</label>
                    <div class="phone-input">
                        <span class="phone-prefix">+7</span>
                        <input type="tel" id="phone" class="form-input phone-number" placeholder="(999) 999-99-99" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="city" class="form-label">Город</label>
                    <select id="city" class="form-input" required>
                        <option value="">Выберите город</option>
                        <option value="almaty">Алматы</option>
                        <option value="astana">Астана</option>
                        <option value="shymkent">Шымкент</option>
                        <option value="semey">Семей</option>
                        <option value="other">Другой</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="address" class="form-label">Адрес</label>
                    <input type="text" id="address" class="form-input" placeholder="Улица, дом, квартира" required>
                </div>
            </div>
            
            <div class="order-section">
                <h3 class="order-section-title"><i class="fas fa-map-marker-alt"></i> Способ получения</h3>
                
                <div class="radio-group">
                    <label class="radio-label" id="pickup-label">
                        <input type="radio" name="delivery" value="pickup" class="radio-input" checked>
                        <div class="radio-info">
                            <div class="radio-title">Самовывоз</div>
                            <div class="radio-description">Забрать из нашего магазина по адресу: г. Семей, ул. Кофейная 77</div>
                        </div>
                        <div class="radio-price">Бесплатно</div>
                    </label>
                    
                    <label class="radio-label" id="courier-label">
                        <input type="radio" name="delivery" value="courier" class="radio-input">
                        <div class="radio-info">
                            <div class="radio-title">Доставка курьером</div>
                            <div class="radio-description">Доставка в течение 1-2 дней</div>
                        </div>
                        <div class="radio-price" id="courier-price">1000 ₸</div>
                    </label>
                </div>
            </div>
            
            <div class="tab-buttons">
                <button class="btn btn-secondary" onclick="prevTab('cart')">
                    <i class="fas fa-arrow-left"></i> Назад
                </button>
                <button class="btn btn-primary" onclick="nextTab('payment')">
                    Продолжить <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Содержимое вкладки "Оплата" -->
        <div class="tab-content" id="payment-tab">
            <h2 class="order-title"><i class="fas fa-credit-card"></i> Способ оплаты</h2>
            
            <div class="order-section">
                <div class="radio-group">
                    <label class="radio-label">
                        <input type="radio" name="payment" value="cash" class="radio-input" checked>
                        <div class="radio-info">
                            <div class="radio-title">Наличными при получении</div>
                            <div class="radio-description">Оплата наличными курьеру или в магазине</div>
                        </div>
                    </label>
                    
                    <label class="radio-label">
                        <input type="radio" name="payment" value="card" class="radio-input">
                        <div class="radio-info">
                            <div class="radio-title">Кредитной картой</div>
                            <div class="radio-description">Visa, Mastercard, Мир</div>
                        </div>
                    </label>
                    
                    <label class="radio-label">
                        <input type="radio" name="payment" value="kaspi" class="radio-input">
                        <div class="radio-info">
                            <div class="radio-title">Kaspi перевод</div>
                            <div class="radio-description">Оплата через приложение Kaspi</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="order-section">
                <h3 class="order-section-title"><i class="fas fa-receipt"></i> Итог заказа</h3>
                
                <div class="order-summary">
                    <div class="order-summary-row">
                        <span>Товары:</span>
                        <span id="payment-subtotal">0 ₸</span>
                    </div>
                    <div class="order-summary-row">
                        <span>Доставка:</span>
                        <span id="payment-delivery">0 ₸</span>
                    </div>
                    <div class="order-total">
                        <span>К оплате:</span>
                        <span id="payment-total">0 ₸</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="comments" class="form-label">Комментарий к заказу (необязательно)</label>
                <textarea id="comments" class="form-input" rows="3" placeholder="Ваши пожелания или особые указания"></textarea>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="agree-terms" class="radio-input" required>
                    <span>Я согласен с <a href="#" style="color: var(--primary-color);">условиями обработки персональных данных</a> и <a href="#" style="color: var(--primary-color);">правилами возврата</a></span>
                </label>
            </div>
            
            <div class="tab-buttons">
                <button class="btn btn-secondary" onclick="prevTab('delivery')">
                    <i class="fas fa-arrow-left"></i> Назад
                </button>
                <button class="btn btn-primary" id="submit-order">
                    Оформить заказ <i class="fas fa-check"></i>
                </button>
            </div>
        </div>
        
        <!-- Содержимое вкладки "Подтверждение" (будет показано после отправки) -->
        <div class="tab-content" id="confirmation-tab" style="text-align: center; padding: 50px 20px;">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 class="order-title">Заказ успешно оформлен!</h2>
            <p style="margin-bottom: 30px; font-size: 18px;">Номер вашего заказа: <strong>#<span id="order-number"></span></strong></p>
            <p style="margin-bottom: 30px;">Мы свяжемся с вами в ближайшее время для подтверждения заказа.</p>
            <button class="btn btn-primary" onclick="window.location.href='index.html'" style="max-width: 300px; margin: 0 auto;">
                <i class="fas fa-home"></i> Вернуться на главную
            </button>
        </div>
    </div>


    <script>
        // Получаем данные из корзины
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const cartCount = document.getElementById('cart-count');
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            // Обновляем счетчик корзины
            cartCount.textContent = cart.length;
            
            // Если корзина пуста, перенаправляем в магазин
            if (cart.length === 0 && !window.location.hash.includes('confirmation')) {
                window.location.href = 'zernashop.html';
                return;
            }
            
            // Показываем товары в корзине
            displayCartItems();
            
            // Инициализируем обработчики событий
            initEventHandlers();
            
            // Проверяем, если это страница подтверждения
            if (window.location.hash === '#confirmation') {
                showConfirmation();
            }
        });
        
        // Функция для отображения товаров в корзине
        function displayCartItems() {
            const orderItemsContainer = document.getElementById('order-items');
            let subtotal = 0;
            
            orderItemsContainer.innerHTML = '';
            
            cart.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'order-item';
                
                itemElement.innerHTML = `
                    <div>
                        <div class="order-item-name">${item.title}</div>
                        <div class="order-item-details">${item.weight}г, ${item.grind}</div>
                    </div>
                    <div class="order-item-price">${item.price.toLocaleString()} ₸</div>
                `;
                
                orderItemsContainer.appendChild(itemElement);
                subtotal += item.price;
            });
            
            // Обновляем суммы
            updateOrderSummary(subtotal);
        }
        
        // Функция обновления итоговой суммы
        function updateOrderSummary(subtotal) {
            const deliveryMethod = document.querySelector('input[name="delivery"]:checked');
            let deliveryCost = 0;
            
            if (deliveryMethod && deliveryMethod.value === 'courier') {
                deliveryCost = subtotal >= 15000 ? 0 : 1000;
            }
            
            const total = subtotal + deliveryCost;
            
            // Обновляем суммы в корзине
            document.getElementById('order-subtotal').textContent = subtotal.toLocaleString() + ' ₸';
            document.getElementById('delivery-cost').textContent = deliveryCost.toLocaleString() + ' ₸';
            document.getElementById('order-total').textContent = total.toLocaleString() + ' ₸';
            
            // Обновляем суммы на странице оплаты
            document.getElementById('payment-subtotal').textContent = subtotal.toLocaleString() + ' ₸';
            document.getElementById('payment-delivery').textContent = deliveryCost.toLocaleString() + ' ₸';
            document.getElementById('payment-total').textContent = total.toLocaleString() + ' ₸';
            
            // Обновляем цену доставки
            if (subtotal >= 15000) {
                document.getElementById('courier-price').textContent = 'Бесплатно';
                if (deliveryMethod && deliveryMethod.value === 'courier') {
                    document.getElementById('delivery-cost').textContent = '0 ₸';
                    document.getElementById('payment-delivery').textContent = '0 ₸';
                    const newTotal = subtotal;
                    document.getElementById('order-total').textContent = newTotal.toLocaleString() + ' ₸';
                    document.getElementById('payment-total').textContent = newTotal.toLocaleString() + ' ₸';
                }
            } else {
                document.getElementById('courier-price').textContent = '1000 ₸';
            }
        }
        
        // Функция инициализации обработчиков событий
        function initEventHandlers() {
            // Обработчики для вкладок
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    if (this.classList.contains('active')) return;
                    
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Обработчики для способов доставки
            document.querySelectorAll('input[name="delivery"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
                    updateOrderSummary(subtotal);
                    
                    // Обновляем стили для label
                    document.querySelectorAll('.radio-label').forEach(label => {
                        label.classList.remove('active');
                    });
                    document.querySelector(`label[for="${this.id}"]`).classList.add('active');
                });
            });
            
            // Обработчик для кнопки оформления заказа
            document.getElementById('submit-order').addEventListener('click', submitOrder);
        }
        
        // Функция переключения вкладок
        function switchTab(tabId) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Деактивируем все табы
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Активируем выбранную вкладку
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Активируем выбранный таб
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            
            // Обновляем прогресс-бар
            updateProgressBar(tabId);
        }
        
        // Функции для кнопок "Назад" и "Продолжить"
        function nextTab(nextTabId) {
            // Простая валидация для вкладки "Доставка"
            if (nextTabId === 'payment') {
                const name = document.getElementById('name').value;
                const phone = document.getElementById('phone').value;
                const city = document.getElementById('city').value;
                const address = document.getElementById('address').value;
                
                if (!name || !phone || !city || !address) {
                    alert('Пожалуйста, заполните все обязательные поля');
                    return;
                }
            }
            
            switchTab(nextTabId);
        }
        
        function prevTab(prevTabId) {
            switchTab(prevTabId);
        }
        
        // Функция обновления прогресс-бара
        function updateProgressBar(currentTab) {
            const progressBar = document.getElementById('checkout-progress');
            let width = '33%';
            
            if (currentTab === 'delivery') {
                width = '66%';
            } else if (currentTab === 'payment') {
                width = '100%';
            }
            
            progressBar.style.width = width;
        }
        
        // Функция оформления заказа
        function submitOrder() {
            // Проверяем согласие с условиями
            if (!document.getElementById('agree-terms').checked) {
                alert('Пожалуйста, подтвердите согласие с условиями обработки данных');
                return;
            }
            
            // Собираем данные заказа
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const city = document.getElementById('city').value;
            const address = document.getElementById('address').value;
            const deliveryMethod = document.querySelector('input[name="delivery"]:checked').value;
            const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const comments = document.getElementById('comments').value;
            
            const subtotal = cart.reduce((sum, item) => sum + item.price, 0);
            const deliveryCost = deliveryMethod === 'courier' && subtotal < 15000 ? 1000 : 0;
            const total = subtotal + deliveryCost;
            
            const order = {
                customer: { 
                    name, 
                    phone: '+7' + phone, 
                    city, 
                    address 
                },
                delivery: {
                    method: deliveryMethod,
                    cost: deliveryCost
                },
                payment: paymentMethod,
                items: cart,
                subtotal,
                total,
                comments,
                date: new Date().toLocaleString(),
                number: 'COF-' + Math.floor(Math.random() * 1000000)
            };
            
            // В реальном приложении здесь был бы AJAX-запрос к серверу
            console.log('Order submitted:', order);
            
            // Показываем подтверждение
            showConfirmation(order.number);
            
            // Очищаем корзину
            localStorage.removeItem('cart');
        }
        
        // Функция показа страницы подтверждения
        function showConfirmation(orderNumber) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Скрываем табы
            document.querySelectorAll('.tab').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Показываем вкладку подтверждения
            const confirmationTab = document.getElementById('confirmation-tab');
            confirmationTab.classList.add('active');
            
            // Устанавливаем номер заказа
            if (orderNumber) {
                document.getElementById('order-number').textContent = orderNumber;
            }
            
            // Обновляем URL
            window.location.hash = 'confirmation';
            
            // Скрываем прогресс-бар
            document.querySelector('.progress-bar').style.display = 'none';
        }
    </script>
</body>
</html>